#!/bin/bash

# sdm-request: Request access to StrongDM resources
# Usage: sdm-request [DURATION] [REASON] [RESOURCE1] [RESOURCE2] ...

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Default values
DEFAULT_DURATION="4h"
DEFAULT_REASON="debugging"

usage() {
    echo "Usage: sdm-request [OPTIONS] [RESOURCE1] [RESOURCE2] ..."
    echo ""
    echo "Options:"
    echo "  -d, --duration DURATION   Duration for access (default: '$DEFAULT_DURATION')"
    echo "  -r, --reason REASON       Reason for access (default: '$DEFAULT_REASON')"
    echo "  -c, --connect             Connect to resources after requesting access"
    echo "  --hex-replicas            Request access to both hex-prod-rds-replica and hex-rc-rds-replica"
    echo "  -h, --help               Show this help message"
    echo ""
    echo "Duration format examples: 4h, 30m, 2h30m, 8h"
    echo ""
    echo "Examples:"
    echo "  sdm-request --hex-replicas"
    echo "  sdm-request --hex-replicas -c                    # Request and connect"
    echo "  sdm-request --hex-replicas -d '8h' -r 'maintenance'"
    echo "  sdm-request hex-prod-rds-replica hex-rc-rds-replica"
    echo "  sdm-request -d '8h' -r 'maintenance' hex-prod-rds-replica"
    echo "  sdm-request -c --duration '2h' --reason 'investigation' hex-prod-rds-replica"
    echo ""
    echo "Common resources:"
    echo "  - hex-prod-rds-replica"
    echo "  - hex-rc-rds-replica" 
    echo "  - hex-staging-rds-replica"
    echo ""
    echo "Note: This script uses the 'sdm' CLI. Make sure it's installed and configured."
}

# Parse command line arguments
DURATION="$DEFAULT_DURATION"
REASON="$DEFAULT_REASON"
RESOURCES=()
HEX_REPLICAS=false
CONNECT_AFTER=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -d|--duration)
            DURATION="$2"
            shift 2
            ;;
        -r|--reason)
            REASON="$2" 
            shift 2
            ;;
        -c|--connect)
            CONNECT_AFTER=true
            shift
            ;;
        --hex-replicas)
            HEX_REPLICAS=true
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        -*)
            echo -e "${RED}Error: Unknown option $1${NC}"
            usage
            exit 1
            ;;
        *)
            RESOURCES+=("$1")
            shift
            ;;
    esac
done

# Add hex replica resources if flag was specified
if [ "$HEX_REPLICAS" = true ]; then
    RESOURCES+=("hex-prod-rds-replica" "hex-rc-rds-replica")
fi

# Check if resources were provided
if [ ${#RESOURCES[@]} -eq 0 ]; then
    echo -e "${RED}Error: No resources specified${NC}"
    usage
    exit 1
fi

# Check if sdm CLI is available
if ! command -v sdm &> /dev/null; then
    echo -e "${RED}Error: 'sdm' command not found. Please install the StrongDM CLI.${NC}"
    echo "Install from: https://www.strongdm.com/docs/admin/install-cli"
    exit 1
fi

# Check if user is logged in
if ! sdm status &> /dev/null; then
    echo -e "${YELLOW}You need to log in to StrongDM first.${NC}"
    echo -e "${BLUE}Running: sdm login${NC}"
    sdm login
fi

echo -e "${BLUE}Requesting access with:${NC}"
echo -e "  ${YELLOW}Duration:${NC} $DURATION"
echo -e "  ${YELLOW}Reason:${NC} $REASON"
echo -e "  ${YELLOW}Resources:${NC} ${RESOURCES[*]}"
echo ""

# Request access for each resource
SUCCESSFUL_REQUESTS=()
FAILED_REQUESTS=()

for resource in "${RESOURCES[@]}"; do
    echo -e "${BLUE}Requesting access to: $resource${NC}"
    
    # Try to request access using the correct SDM syntax
    echo -e "${YELLOW}Running: sdm access to \"$resource\" --duration \"$DURATION\" --reason \"$REASON\"${NC}"
    if OUTPUT=$(sdm access to "$resource" --duration "$DURATION" --reason "$REASON" 2>&1); then
        echo -e "${GREEN}✓ Successfully requested access to $resource${NC}"
        echo -e "${GREEN}  Request ID: $OUTPUT${NC}"
        SUCCESSFUL_REQUESTS+=("$resource")
    else
        echo -e "${RED}✗ Failed to request access to $resource${NC}"
        echo -e "${RED}  Error: $OUTPUT${NC}"
        FAILED_REQUESTS+=("$resource")
    fi
    echo ""
done

# Summary
echo -e "${BLUE}=== Summary ===${NC}"
if [ ${#SUCCESSFUL_REQUESTS[@]} -gt 0 ]; then
    echo -e "${GREEN}Successfully requested access to:${NC}"
    for resource in "${SUCCESSFUL_REQUESTS[@]}"; do
        echo -e "  ✓ $resource"
    done
fi

if [ ${#FAILED_REQUESTS[@]} -gt 0 ]; then
    echo -e "${RED}Failed to request access to:${NC}"
    for resource in "${FAILED_REQUESTS[@]}"; do
        echo -e "  ✗ $resource"
    done
    echo ""
    echo -e "${YELLOW}You may need to request these manually or check your permissions.${NC}"
fi

echo ""

# Connect to resources if requested
if [ "$CONNECT_AFTER" = true ] && [ ${#SUCCESSFUL_REQUESTS[@]} -gt 0 ]; then
    echo -e "${BLUE}=== Connecting to Resources ===${NC}"
    echo -e "${YELLOW}Note: Connections will be established in the background.${NC}"
    echo -e "${YELLOW}Use 'sdm status' to see active connections.${NC}"
    echo ""
    
    for resource in "${SUCCESSFUL_REQUESTS[@]}"; do
        echo -e "${BLUE}Connecting to: $resource${NC}"
        if sdm connect "$resource" 2>&1; then
            echo -e "${GREEN}✓ Connection established to $resource${NC}"
        else
            echo -e "${YELLOW}⚠ Connection may be establishing in background for $resource${NC}"
            echo -e "${YELLOW}  Check 'sdm status' to verify connection${NC}"
        fi
        echo ""
    done
    
    echo -e "${BLUE}Connection commands:${NC}"
    echo -e "${YELLOW}Check status:${NC} sdm status"
    echo -e "${YELLOW}Disconnect:${NC} sdm disconnect <resource-name>"
    echo -e "${YELLOW}Disconnect all:${NC} sdm disconnect --all"
    echo ""
fi

echo -e "${BLUE}You can check your access requests with:${NC} sdm access requests"